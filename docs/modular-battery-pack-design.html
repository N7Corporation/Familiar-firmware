<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familiar Modular Battery Pack System - PCB Design</title>
    <style>
        @media print {
            body { font-size: 9pt; }
            pre { font-size: 8pt; page-break-inside: avoid; }
            h1, h2, h3 { page-break-after: avoid; }
            table { page-break-inside: avoid; }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background: #fff;
        }

        h1 {
            color: #1a1a2e;
            border-bottom: 3px solid #4a90d9;
            padding-bottom: 10px;
        }

        h2 {
            color: #16213e;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-top: 30px;
        }

        h3 {
            color: #1a1a2e;
            margin-top: 20px;
        }

        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SF Mono', 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.9em;
        }

        pre code {
            background: none;
            padding: 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: left;
        }

        th {
            background: #4a90d9;
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        .specs-box {
            background: #e8f4f8;
            border-left: 4px solid #4a90d9;
            padding: 15px;
            margin: 15px 0;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
        }

        .section-divider {
            border: none;
            height: 2px;
            background: linear-gradient(to right, #4a90d9, transparent);
            margin: 30px 0;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .header-info div {
            margin: 5px 15px 5px 0;
        }

        .header-info strong {
            color: #4a90d9;
        }
    </style>
</head>
<body>

<h1>Familiar Modular Battery Pack System</h1>
<h2>PCB Design Specification</h2>

<div class="header-info">
    <div><strong>Target Device:</strong> Familiar Firmware (Raspberry Pi 5V @ 3A)</div>
    <div><strong>Configuration:</strong> 2S Li-ion (7.4V nominal, 6.0V-8.4V range)</div>
    <div><strong>Architecture:</strong> Distributed BMS (hot-swap capable)</div>
    <div><strong>Buck Converter:</strong> Allegro A6211GLJTR-T</div>
</div>

<hr class="section-divider">

<h2>1. System Overview</h2>

<pre>
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│   PACK 1    │   │   PACK 2    │   │   PACK 3    │
│  2S 21700   │   │  2S 21700   │   │  2S 21700   │
│  + BMS      │   │  + BMS      │   │  + BMS      │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       └────────┬────────┴────────┬────────┘
                │   OR-ing Diodes │
                │   (hot-swap)    │
                ▼                 ▼
        ┌───────────────────────────────┐
        │      MAIN BOARD               │
        │  ┌─────────────────────────┐  │
        │  │  Custom Buck Converter  │  │
        │  │  A6211 - 5V @ 2A        │  │
        │  └─────────────────────────┘  │
        │              │                │
        │              ▼                │
        │         5V Rail → Pi         │
        └───────────────────────────────┘
</pre>

<hr class="section-divider">

<h2>2. Battery Pack Module (SMD Version)</h2>

<div class="specs-box">
    <strong>Board Size:</strong> 55mm x 35mm<br>
    <strong>Layers:</strong> 2-layer, 1oz copper<br>
    <strong>Cell Format:</strong> 21700 Li-ion (2S series)
</div>

<h3>2.1 PCB Layout</h3>

<pre>
┌─────────────────────────────────────────────────────────────────┐
│                   BATTERY PACK PCB (SMD)                        │
│                                                                 │
│  ┌────────────┐      ┌────────────┐                            │
│  │  21700     │      │  21700     │                            │
│  │  CELL 1    │      │  CELL 2    │    2S / 7.4V nom           │
│  │            │      │            │                            │
│  │  nickel    │      │  nickel    │                            │
│  │  strips    │      │  strips    │                            │
│  └─────┬──────┘      └─────┬──────┘                            │
│        │                   │                                    │
│  ══════╪═══════════════════╪════════════════════════════       │
│        │    SERIES CONN    │                                    │
│   B- ──┴───────────────────┴── B+ (to BMS)                     │
│                   │BM (balance mid)                             │
│                   │                                             │
│   ┌───────────────┴───────────────────────────────────┐        │
│   │              2S BMS (SMD ICs)                     │        │
│   │                                                   │        │
│   │  ┌────────┐  ┌────────┐  ┌────────┐             │        │
│   │  │S8254AA │  │FS8205A │  │FS8205A │             │        │
│   │  │ TSSOP8 │  │ TSSOP8 │  │ TSSOP8 │             │        │
│   │  │        │  │DUAL FET│  │DUAL FET│             │        │
│   │  │PROTECT │  │ CHG    │  │ DSG    │             │        │
│   │  └───┬────┘  └───┬────┘  └───┬────┘             │        │
│   │      │           │           │                   │        │
│   │  ┌───┴───┐   ┌───┴───┐   ┌───┴───┐              │        │
│   │  │0402   │   │0402   │   │0402   │  resistors   │        │
│   │  │100Ω   │   │1kΩ    │   │1kΩ    │              │        │
│   │  └───────┘   └───────┘   └───────┘              │        │
│   │                                                   │        │
│   │  NTC ●──[0402 10k]──┐  thermistor input         │        │
│   │                      │                           │        │
│   └──────────────────────┴───────────────────────────┘        │
│                          │                                     │
│              P- ─────────┴─────── P+                           │
│               │                   │                            │
│   ┌───────────┴───────────────────┴───────────────┐           │
│   │         6-PIN POGO/SPRING CONNECTOR           │           │
│   │  ┌───┬───┬───┬───┬───┬───┐                   │           │
│   │  │P- │P- │NTC│ID │P+ │P+ │ (dual pins        │           │
│   │  └───┴───┴───┴───┴───┴───┘   for current)    │           │
│   └───────────────────────────────────────────────┘           │
│                                                                │
│   LED: 0603 RED/GRN common cathode (charge status)            │
│                                                                │
└─────────────────────────────────────────────────────────────────┘
</pre>

<h3>2.2 BMS Protection Circuit</h3>

<pre>
        B- (Cell 1 negative)
         │
         │      ┌─────────────────────────────────────┐
         │      │           S8254AA                   │
         │      │         (Protection IC)             │
         │      │                                     │
         │      │  OVP: 4.25V/cell (overcharge)      │
         │      │  ODP: 2.5V/cell  (over-discharge)  │
         │      │  OCP: 8A         (overcurrent)     │
         │      │  SCP: 25A        (short circuit)   │
         │      │                                     │
         │      │  VDD ────── B+                     │
         │      │  VSS ────── B-                     │
         │      │  VM  ────── Balance Mid            │
         │      │  CO  ────── Charge FET Gate        │
         │      │  DO  ────── Discharge FET Gate     │
         │      └─────────────────────────────────────┘
         │
         ├──────┤FS8205A├──────┤FS8205A├────── P-
         │      (CHG FET)      (DSG FET)
         │
        GND
</pre>

<hr class="section-divider">

<h2>3. Main Board Power Section (SMD)</h2>

<div class="specs-box">
    <strong>Layers:</strong> 4-layer recommended (dedicated power/ground planes)<br>
    <strong>Input Voltage:</strong> 6.0V - 8.4V (from battery packs)<br>
    <strong>Output:</strong> 5V @ 2A continuous (3A peak)
</div>

<h3>3.1 PCB Layout</h3>

<pre>
┌──────────────────────────────────────────────────────────────────────────┐
│                    MAIN BOARD - POWER SECTION (SMD)                      │
│                                                                          │
│  PACK CONNECTORS (spring-loaded pogo receptacles)                        │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐                           │
│  │  PACK 1  │    │  PACK 2  │    │  PACK 3  │                           │
│  │  6-pin   │    │  6-pin   │    │  6-pin   │                           │
│  └────┬─────┘    └────┬─────┘    └────┬─────┘                           │
│       │               │               │                                  │
│       │    ┌──────────┴───────────────┤                                 │
│       │    │                          │                                  │
│  ┌────┴────┴────┐              ┌──────┴─────┐                           │
│  │ SS34 x3      │              │ ID/NTC     │                           │
│  │ DO-214AB     │              │ to MCU     │  pack detection           │
│  │ (OR-ing)     │              │ GPIO/ADC   │                           │
│  └──────┬───────┘              └────────────┘                           │
│         │                                                                │
│         │ VBAT (6V - 8.4V)                                              │
│         │                                                                │
│  ┌──────┴──────┐    ┌─────────────────┐                                 │
│  │ 100µF x2    │    │  SUPERCAP       │                                 │
│  │ 1206 MLCC   │    │  1F 10V         │   hot-swap ride-through        │
│  │ 25V X5R     │    │  (through-hole) │                                 │
│  └──────┬──────┘    └────────┬────────┘                                 │
│         │                    │                                           │
│         └─────────┬──────────┘                                          │
│                   │                                                      │
│ ══════════════════╪══════════════════════════════════════════════       │
│                   │                                                      │
│         ┌─────────┴─────────────────────────────────────────┐           │
│         │           CUSTOM BUCK CONVERTER                    │           │
│         │           A6211 - 5V @ 2A                          │           │
│         │                                                    │           │
│         │   VIN ──┬──[L1]──┬── VOUT (5V)                    │           │
│         │         │        │                                 │           │
│         │    ┌────┴────┐   │                                │           │
│         │    │ A6211   │   ├──[C_OUT]──┐                    │           │
│         │    │ SOT23-8L│   │           │                    │           │
│         │    └─────────┘   │      ┌────┴────┐               │           │
│         │                  │      │ 22µF x2 │               │           │
│         │   L1: 10µH       │      │ 0805    │               │           │
│         │   IHLP2525       │      └─────────┘               │           │
│         │                  │                                 │           │
│         └──────────────────┴─────────────────────────────────┘           │
│                   │                                                      │
│                   │ 5V @ 2A                                             │
│ ══════════════════╪══════════════════════════════════════════════       │
│                   │                                                      │
│         ┌─────────┴─────────┐                                           │
│         │  POWER MONITOR    │                                           │
│         │  INA219 (MSOP10)  │──→ I2C to Pi (SDA/SCL)                   │
│         │  R_SHUNT: 0.01Ω   │                                           │
│         └─────────┬─────────┘                                           │
│                   │                                                      │
│              5V RAIL ──────────────────→ To Raspberry Pi                │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
</pre>

<hr class="section-divider">

<h2>4. Buck Converter Design (A6211GLJTR-T)</h2>

<h3>4.1 Specifications</h3>

<table>
    <tr><th>Parameter</th><th>Value</th></tr>
    <tr><td>Input Voltage</td><td>6.0V - 8.4V (2S Li-ion)</td></tr>
    <tr><td>Output Voltage</td><td>5.0V</td></tr>
    <tr><td>Output Current</td><td>2A continuous, 3A peak</td></tr>
    <tr><td>Switching Frequency</td><td>~300kHz (set by RTON)</td></tr>
    <tr><td>Efficiency</td><td>~90% typical</td></tr>
    <tr><td>Package</td><td>SOT23-8L + Thermal Pad</td></tr>
</table>

<h3>4.2 A6211 Pinout</h3>

<table>
    <tr><th>Pin</th><th>Name</th><th>Connection</th></tr>
    <tr><td>1</td><td>VIN</td><td>Battery input + 10µF cap</td></tr>
    <tr><td>2</td><td>TON</td><td>150kΩ to GND (sets ~300kHz)</td></tr>
    <tr><td>3</td><td>EN</td><td>100kΩ to VIN (always on)</td></tr>
    <tr><td>4</td><td>CS</td><td>Feedback divider (49.9k/10k)</td></tr>
    <tr><td>5</td><td>VCC</td><td>Tie to VIN + 0.1µF bypass</td></tr>
    <tr><td>6</td><td>GND</td><td>Ground plane</td></tr>
    <tr><td>7</td><td>BOOT</td><td>0.1µF to SW</td></tr>
    <tr><td>8</td><td>SW</td><td>To inductor</td></tr>
    <tr><td>9</td><td>PAD</td><td>Solder to GND (thermal)</td></tr>
</table>

<h3>4.3 Schematic</h3>

<pre>
                              VIN (6V - 8.4V)
                                    │
                   ┌────────────────┴────────────────┐
                   │                                 │
              ┌────┴────┐                      ┌─────┴─────┐
              │ 10µF    │                      │ 0.1µF     │
              │ 1206    │                      │ 0402      │
              │ 25V     │                      │           │
              └────┬────┘                      └─────┬─────┘
                   │                                 │
                   └────────────────┬────────────────┘
                                    │
                              VIN ──┤1
                                    │
              ┌──────────┐    TON ──┤2          5├── VCC ──┬── VIN
              │ RTON     │          │              │        │
              │ 150kΩ    ├──────────┤     A6211   │   ┌────┴────┐
              │ 0402     │          │              │   │ 0.1µF   │
              └────┬─────┘     EN ──┤3          8├─SW │ 0402    │
                   │           │    │              │   └────┬────┘
                   │      ┌────┴────┤            7├─BOOT    │
                   │      │100kΩ    │              │  │     │
                   │      │0402     │     PAD    CS├4 │  ┌──┴──┐
                   │      └────┬────┤9          6├─┴──┼──┤0.1µF│
                   │           │    └──────┬───────┘  │  │0402 │
                   │           │           │          │  └──┬──┘
                   └───────────┴───────────┴──GND     │     │
                                                      │     │
                                          ┌───────────┴─────┘
                                          │
                                    ┌─────┴─────┐
                                    │ L1 10µH   │  (A6211 prefers
                                    │ IHLP2525  │   higher L than
                                    │ 4A SAT    │   MP2315)
                                    └─────┬─────┘
                                          │
             ┌────────────────────────────┴───────────────┐
             │                            │               │
        ┌────┴────┐                  ┌────┴────┐    ┌─────┴─────┐
        │ 22µF x2 │                  │ 49.9kΩ  │    │  VOUT     │
        │ 0805    │                  │ 0402 1% │    │  5V       │
        │ 10V X5R │                  │ (R_TOP) │    │           │
        └────┬────┘                  └────┬────┘    └───────────┘
             │                            │
             │                       CS ──┤ (Pin 4, feedback)
             │                            │
             │                       ┌────┴────┐
             │                       │ 10kΩ    │
             │                       │ 0402 1% │
             │                       │ (R_BOT) │
             │                       └────┬────┘
             │                            │
             └────────────────────────────┴──────────── GND
</pre>

<h3>4.4 Output Voltage Calculation</h3>

<div class="specs-box">
<pre>
VOUT = VREF × (1 + R_TOP / R_BOT)
VOUT = 1.0V × (1 + 49.9kΩ / 10kΩ)
VOUT = 1.0V × 5.99
VOUT ≈ 5.0V
</pre>
</div>

<h3>4.5 Frequency Setting</h3>

<div class="specs-box">
<pre>
f_SW = 5000 / RTON(kΩ)
f_SW = 5000 / 150
f_SW ≈ 333 kHz
</pre>
</div>

<hr class="section-divider">

<h2>5. Hot-Swap Circuit</h2>

<h3>5.1 OR-ing Diode Configuration</h3>

<pre>
Pack 1 ──┬──|>|──┐
         │ SS34  │
Pack 2 ──┼──|>|──┼───┬────[SUPERCAP]────┬────[BUCK]──→ 5V
         │ SS34  │   │     1F 10V       │
Pack 3 ──┴──|>|──┘   └────[100µF x2]────┘
            SS34
</pre>

<h3>5.2 Ride-Through Calculation</h3>

<div class="specs-box">
<pre>
Supercap Energy:   E = ½CV² = ½ × 1F × (8.4V)² = 35.3J
Power Draw:        P = 5V × 2A = 10W
Hold-up Time:      t = E/P = 35.3J / 10W ≈ 3.5 seconds

(Actual time lower due to dropout voltage, but >500ms guaranteed)
</pre>
</div>

<hr class="section-divider">

<h2>6. Bill of Materials</h2>

<h3>6.1 Battery Pack BOM</h3>

<table>
    <tr><th>Ref</th><th>Part Number</th><th>Package</th><th>Value</th><th>Qty</th><th>Description</th></tr>
    <tr><td>U1</td><td>S8254AA</td><td>TSSOP-8</td><td>-</td><td>1</td><td>2S Protection IC</td></tr>
    <tr><td>U2,U3</td><td>FS8205A</td><td>TSSOP-8</td><td>-</td><td>2</td><td>Dual N-FET</td></tr>
    <tr><td>R1</td><td>-</td><td>0402</td><td>100Ω</td><td>1</td><td>Current sense</td></tr>
    <tr><td>R2,R3</td><td>-</td><td>0402</td><td>1kΩ</td><td>2</td><td>Gate resistors</td></tr>
    <tr><td>R4</td><td>-</td><td>0402</td><td>10kΩ</td><td>1</td><td>NTC pullup</td></tr>
    <tr><td>NTC1</td><td>NCP18XH103F03RB</td><td>0402</td><td>10kΩ</td><td>1</td><td>Thermistor</td></tr>
    <tr><td>LED1</td><td>-</td><td>0603</td><td>R/G</td><td>1</td><td>Status LED</td></tr>
    <tr><td>J1</td><td>-</td><td>-</td><td>6-pin</td><td>1</td><td>Pogo connector</td></tr>
</table>

<h3>6.2 Main Board Power Section BOM</h3>

<table>
    <tr><th>Ref</th><th>Part Number</th><th>Package</th><th>Value</th><th>Qty</th><th>Description</th></tr>
    <tr><td>U1</td><td>A6211GLJTR-T</td><td>SOT23-8L</td><td>-</td><td>1</td><td>Sync buck converter</td></tr>
    <tr><td>U2</td><td>INA219</td><td>MSOP-10</td><td>-</td><td>1</td><td>Power monitor</td></tr>
    <tr><td>L1</td><td>IHLP2525CZER100M01</td><td>2525</td><td>10µH</td><td>1</td><td>Power inductor</td></tr>
    <tr><td>D1-D3</td><td>SS34</td><td>DO-214AB</td><td>40V 3A</td><td>3</td><td>Schottky diodes</td></tr>
    <tr><td>C1</td><td>GRM31CR61E106K</td><td>1206</td><td>10µF 25V</td><td>2</td><td>Input capacitor</td></tr>
    <tr><td>C2</td><td>GRM21BR61A226M</td><td>0805</td><td>22µF 10V</td><td>2</td><td>Output capacitor</td></tr>
    <tr><td>C3-C5</td><td>-</td><td>0402</td><td>0.1µF 25V</td><td>3</td><td>Bypass capacitors</td></tr>
    <tr><td>C6</td><td>-</td><td>Radial</td><td>1F 10V</td><td>1</td><td>Supercapacitor</td></tr>
    <tr><td>R1</td><td>-</td><td>0402</td><td>150kΩ 1%</td><td>1</td><td>TON resistor</td></tr>
    <tr><td>R2</td><td>-</td><td>0402</td><td>100kΩ 1%</td><td>1</td><td>EN pullup</td></tr>
    <tr><td>R3</td><td>-</td><td>0402</td><td>49.9kΩ 1%</td><td>1</td><td>FB divider top</td></tr>
    <tr><td>R4</td><td>-</td><td>0402</td><td>10kΩ 1%</td><td>1</td><td>FB divider bottom</td></tr>
    <tr><td>R5</td><td>WSL2512R0100F</td><td>2512</td><td>0.01Ω 1W</td><td>1</td><td>Current shunt</td></tr>
    <tr><td>J1-J3</td><td>-</td><td>-</td><td>6-pin</td><td>3</td><td>Pogo receptacles</td></tr>
</table>

<hr class="section-divider">

<h2>7. Layout Guidelines</h2>

<h3>7.1 Buck Converter Layout (Critical)</h3>

<pre>
┌─────────────────────────────────────────────────┐
│                                                 │
│  INPUT CAPS (C_IN)                             │
│  ┌───────┐                                      │
│  │ 10µF  │ ← Place within 3mm of VIN pin       │
│  └───┬───┘                                      │
│      │                                          │
│      │   ┌────────────┐                        │
│      └───┤   A6211    ├───┐                    │
│          └────────────┘   │                    │
│               SW pin ─────┤                    │
│                           │                    │
│               ┌───────────┴───────────┐        │
│               │      INDUCTOR         │        │
│               │       10µH            │        │
│               │  (short, wide trace)  │        │
│               └───────────┬───────────┘        │
│                           │                    │
│               ┌───────────┴───────────┐        │
│               │   OUTPUT CAPS (x2)    │        │
│               │  Place close to L1    │        │
│               └───────────────────────┘        │
│                                                 │
│  CRITICAL NOTES:                               │
│  • Keep SW node trace short and small (EMI)    │
│  • Wide ground plane under entire converter    │
│  • Multiple vias for thermal dissipation       │
│  • Bootstrap cap close to BOOT pin             │
│  • CS trace away from SW node                  │
│  • Thermal pad (pin 9) needs vias to GND       │
│                                                 │
└─────────────────────────────────────────────────┘
</pre>

<h3>7.2 Power Plane Recommendations</h3>

<table>
    <tr><th>Layer</th><th>Purpose</th></tr>
    <tr><td>Layer 1 (Top)</td><td>Signal + component placement</td></tr>
    <tr><td>Layer 2</td><td>Ground plane (unbroken under buck converter)</td></tr>
    <tr><td>Layer 3</td><td>Power plane (VBAT, 5V rails)</td></tr>
    <tr><td>Layer 4 (Bottom)</td><td>Signal + additional components</td></tr>
</table>

<hr class="section-divider">

<h2>8. Connector System (Pogo Pins)</h2>

<h3>8.1 Overview</h3>

<p>The battery pack uses a 6-pin pogo/spring pin connector system for hot-swap capability. This allows packs to be inserted and removed without tools while maintaining reliable electrical contact.</p>

<h3>8.2 Connector Layout</h3>

<pre>
BATTERY PACK SIDE (Male Pogo Pads)
┌─────────────────────────────────────┐
│                                     │
│   ●───●───●───●───●───●            │
│   1   2   3   4   5   6            │
│   P-  P-  NTC ID  P+  P+           │
│                                     │
│   Pad size: 2.0mm diameter         │
│   Pitch: 2.54mm (0.1")             │
│   Gold plated: ENIG recommended    │
│                                     │
└─────────────────────────────────────┘

MAIN BOARD SIDE (Female Pogo Receptacles)
┌─────────────────────────────────────┐
│                                     │
│   ◎───◎───◎───◎───◎───◎            │
│   1   2   3   4   5   6            │
│   P-  P-  NTC ID  P+  P+           │
│                                     │
│   Spring-loaded pogo pins          │
│   Travel: 1.0-1.5mm                │
│   Current rating: 2A per pin       │
│                                     │
└─────────────────────────────────────┘
</pre>

<h3>8.3 Pin Assignment</h3>

<table>
    <tr><th>Pin</th><th>Signal</th><th>Description</th><th>Trace Width</th><th>Notes</th></tr>
    <tr><td>1</td><td>P-</td><td>Pack negative</td><td>1.0mm min</td><td>Power return</td></tr>
    <tr><td>2</td><td>P-</td><td>Pack negative</td><td>1.0mm min</td><td>Paralleled for 4A total</td></tr>
    <tr><td>3</td><td>NTC</td><td>Temperature</td><td>0.2mm</td><td>10k NTC to GND</td></tr>
    <tr><td>4</td><td>ID</td><td>Pack ID</td><td>0.2mm</td><td>Resistor divider for pack type</td></tr>
    <tr><td>5</td><td>P+</td><td>Pack positive</td><td>1.0mm min</td><td>Main power</td></tr>
    <tr><td>6</td><td>P+</td><td>Pack positive</td><td>1.0mm min</td><td>Paralleled for 4A total</td></tr>
</table>

<h3>8.4 Recommended Pogo Pin Parts</h3>

<table>
    <tr><th>Component</th><th>Part Number</th><th>Description</th></tr>
    <tr><td>Pogo Pin (receptacle)</td><td>Mill-Max 0906-0-15-20-76-14-11-0</td><td>Spring probe, 2A rated</td></tr>
    <tr><td>Target Pad</td><td>Mill-Max 2199-0-00-80-00-00-03-0</td><td>Gold plated target</td></tr>
    <tr><td>Alternative</td><td>Coda Systems P50-series</td><td>Lower cost option</td></tr>
</table>

<h3>8.5 Mating Mechanism</h3>

<pre>
SIDE VIEW - PACK INSERTION

         Pack PCB
         ┌───────────────────┐
         │   ●   ●   ●   ●   │  ← Target pads (gold plated)
         └───────────────────┘
              ↓   ↓   ↓   ↓      Insertion direction
         ┌───────────────────┐
         │   ◎   ◎   ◎   ◎   │  ← Pogo pins (spring loaded)
         │   ║   ║   ║   ║   │     compress 1mm on contact
         └───────────────────┘
         Main Board

ALIGNMENT FEATURES:
- Add alignment posts/slots to enclosure
- 0.5mm tolerance on pad placement
- Chamfered entry on enclosure for guided insertion
</pre>

<h3>8.6 ID Pin Resistor Values</h3>

<p>The ID pin uses a resistor divider to identify pack type/capacity:</p>

<table>
    <tr><th>Pack Type</th><th>R_ID to GND</th><th>Voltage at ID</th><th>Detected As</th></tr>
    <tr><td>Standard 2S 5Ah</td><td>10k</td><td>1.65V</td><td>Type 0</td></tr>
    <tr><td>Extended 2S 10Ah</td><td>22k</td><td>2.27V</td><td>Type 1</td></tr>
    <tr><td>High-drain 2S 5Ah</td><td>33k</td><td>2.56V</td><td>Type 2</td></tr>
    <tr><td>Reserved</td><td>47k</td><td>2.77V</td><td>Type 3</td></tr>
</table>

<p><em>Main board has 10k pullup to 3.3V on ID pin</em></p>

<h3>8.7 NTC Connection</h3>

<pre>
BATTERY PACK:
                    ┌─────────────┐
    NTC Pin (3) ────┤ 10kΩ NTC    ├──── GND (via P-)
                    │ 0402        │
                    └─────────────┘

MAIN BOARD:
                    ┌─────────────┐
    3.3V ───────────┤ 10kΩ        ├──── NTC Pin (3) ──→ ADC
                    │ pullup      │
                    └─────────────┘

Temperature Calculation:
- At 25°C: NTC = 10kΩ, Vout = 1.65V
- At 45°C: NTC ≈ 4.5kΩ, Vout = 1.02V
- At 0°C: NTC ≈ 27kΩ, Vout = 2.41V
</pre>

<hr class="section-divider">

<h2>9. Thermal Considerations</h2>

<table>
    <tr><th>Component</th><th>Power Dissipation</th><th>Notes</th></tr>
    <tr><td>A6211</td><td>~0.5W</td><td>Add thermal vias to ground plane</td></tr>
    <tr><td>SS34 diodes</td><td>~0.3W each</td><td>Adequate copper pour</td></tr>
    <tr><td>FS8205A FETs</td><td>~0.2W each</td><td>Spread across PCB</td></tr>
    <tr><td>Shunt resistor</td><td>~0.1W</td><td>2512 package handles this</td></tr>
</table>

<div class="warning-box">
    <strong>Thermal Pad Important:</strong> The A6211 has an exposed thermal pad (Pin 9) that MUST be soldered to the ground plane with multiple thermal vias for proper heat dissipation.
</div>

<hr class="section-divider">

<hr class="section-divider">

<h2>10. Centralized Charging System</h2>

<h3>10.1 Overview</h3>

<p>Charging is handled by the main module rather than individual packs. This provides:</p>
<ul>
    <li>Single USB-C input for all packs</li>
    <li>Intelligent charge management via Pi</li>
    <li>Temperature monitoring per pack</li>
    <li>Sequential charging (one pack at a time)</li>
</ul>

<h3>10.2 System Architecture</h3>

<pre>
                                  MAIN MODULE
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   USB-C PD          CHARGE                    PACK SELECT              │
│   INPUT             CONTROLLER                (one at a time)           │
│                                                                         │
│  ┌───────┐      ┌─────────────┐         ┌──────────────────┐           │
│  │USB-C  │      │  BQ25895    │         │   CHARGE MUX     │           │
│  │ PD    │──────│  or         │─────────│   (P-FETs)       │           │
│  │       │      │  BQ24195    │         │                  │           │
│  └───────┘      │             │         │  ┌──┐ ┌──┐ ┌──┐ │           │
│     │           │  CC/CV      │         │  │P1│ │P2│ │P3│ │           │
│     │           │  8.4V 2A    │         │  └┬─┘ └┬─┘ └┬─┘ │           │
│  ┌──┴──┐        └─────────────┘         └───┼────┼────┼───┘           │
│  │STUSB│                                    │    │    │               │
│  │4500 │        DISCHARGE PATH              │    │    │               │
│  │(PD) │        (OR-ing diodes)             │    │    │               │
│  └─────┘        ───────────────             │    │    │               │
│                      │                      │    │    │               │
│                      ▼                      ▼    ▼    ▼               │
│                 ┌─────────┐            ┌─────────────────┐            │
│                 │  BUCK   │            │  PACK CONNECTORS │            │
│                 │  A6211  │            │  (6-pin pogo)    │            │
│                 │  5V 2A  │            └─────────────────┘            │
│                 └────┬────┘                  │    │    │               │
│                      │                       │    │    │               │
│                      ▼                       ▼    ▼    ▼               │
│                   5V OUT              PACK 1  PACK 2  PACK 3          │
│                   TO PI                                               │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
</pre>

<h3>10.3 Charge Controller Circuit (BQ25895)</h3>

<pre>
                         VBUS (5V-20V from USB-C PD)
                              │
                         ┌────┴────┐
                         │ 10µF    │
                         │ 25V     │
                         └────┬────┘
                              │
         ┌────────────────────┴────────────────────────────────────┐
         │                                                         │
         │  VBUS ─┤1                                          24├─ PMID
         │        │                                              │
         │   D+ ──┤2        BQ25895                           23├─ SYS ──→ System
         │        │         (QFN-24)                             │
         │   D- ──┤3                                          22├─ BTST
         │        │                                              │    │
         │  ILIM ─┤4                                          21├────┼─[0.1µF]
         │    │   │                                              │    │
         │  [Rilim]                                           20├─ SW ┘
         │    │   │                                              │    │
         │   GND  │                                              │   [L]
         │        │                                              │  2.2µH
         │   TS ──┤5   (temp sense from pack NTC)            19├────┴────┐
         │        │                                              │         │
         │  QON ──┤6                                          18├─ BAT ───┴──→ CHG MUX
         │        │                                              │
         │  CE ───┤7   (charge enable, GPIO)                 17├─ REGN
         │        │                                              │    │
         │  SDA ──┤8                                          16├────┴─[1µF]
         │        │                                              │
         │  SCL ──┤9                                          15├─ STAT ──→ LED
         │        │                                              │
         │  INT ──┤10                                         14├─ OTG
         │        │                                              │
         │  PSEL ─┤11                                         13├─ NC
         │        │                                              │
         │  GND ──┤12                                         PAD├─ GND
         │        │                                              │
         └────────┴──────────────────────────────────────────────┘
</pre>

<h3>10.4 Key BQ25895 Connections</h3>

<table>
    <tr><th>Pin</th><th>Name</th><th>Connection</th><th>Notes</th></tr>
    <tr><td>1</td><td>VBUS</td><td>USB-C VBUS</td><td>5-14V input</td></tr>
    <tr><td>2,3</td><td>D+/D-</td><td>USB data lines</td><td>For BC1.2 detection</td></tr>
    <tr><td>4</td><td>ILIM</td><td>1kΩ to GND</td><td>Sets 2A input limit</td></tr>
    <tr><td>5</td><td>TS</td><td>Pack NTC (via mux)</td><td>Temperature sensing</td></tr>
    <tr><td>7</td><td>CE</td><td>Pi GPIO</td><td>Charge enable</td></tr>
    <tr><td>8,9</td><td>SDA/SCL</td><td>Pi I2C</td><td>Configuration</td></tr>
    <tr><td>15</td><td>STAT</td><td>LED/GPIO</td><td>Charge status</td></tr>
    <tr><td>18</td><td>BAT</td><td>Charge MUX input</td><td>8.4V output</td></tr>
    <tr><td>20</td><td>SW</td><td>Inductor</td><td>Switching node</td></tr>
</table>

<h3>10.5 Charge MUX Circuit</h3>

<p>The charge MUX uses P-channel MOSFETs to route charge current to one pack at a time:</p>

<pre>
                    CHARGE OUTPUT (from BQ25895 BAT pin)
                              │
              ┌───────────────┼───────────────┐
              │               │               │
         ┌────┴────┐     ┌────┴────┐     ┌────┴────┐
         │ Si2301  │     │ Si2301  │     │ Si2301  │
         │ P-FET   │     │ P-FET   │     │ P-FET   │
         │         │     │         │     │         │
         │ S ── D  │     │ S ── D  │     │ S ── D  │
         │    │    │     │    │    │     │    │    │
         └────┼────┘     └────┼────┘     └────┼────┘
              │G              │G              │G
              │               │               │
         ┌────┴────┐     ┌────┴────┐     ┌────┴────┐
         │ 10kΩ    │     │ 10kΩ    │     │ 10kΩ    │
         │ pullup  │     │ pullup  │     │ pullup  │
         └────┬────┘     └────┬────┘     └────┬────┘
              │               │               │
              │               │               │
         GPIO_CHG1       GPIO_CHG2       GPIO_CHG3
         (from Pi)       (from Pi)       (from Pi)
         LOW=charge      LOW=charge      LOW=charge
              │               │               │
              ▼               ▼               ▼
         PACK 1 P+       PACK 2 P+       PACK 3 P+
</pre>

<div class="specs-box">
    <strong>MUX Operation:</strong><br>
    - All GPIOs HIGH (default): No charging, FETs OFF<br>
    - GPIO_CHG1 LOW: Pack 1 charges, others isolated<br>
    - Only ONE GPIO should be LOW at a time
</div>

<h3>10.6 USB-C Power Delivery</h3>

<pre>
┌─────────────────────────────────────────────────────────────────┐
│                     USB-C PD CIRCUIT                            │
│                                                                 │
│   USB-C Connector          STUSB4500              To BQ25895   │
│   ┌─────────────┐         ┌─────────────┐                      │
│   │             │         │             │                      │
│   │  VBUS ──────┼─────────┤ VBUS    VIN ├────────→ VBUS       │
│   │             │         │             │                      │
│   │  CC1 ───────┼─────────┤ CC1         │                      │
│   │             │         │             │                      │
│   │  CC2 ───────┼─────────┤ CC2     SDA ├────────→ Pi I2C     │
│   │             │         │             │                      │
│   │  D+ ────────┼─────────┤         SCL ├────────→ Pi I2C     │
│   │             │         │             │                      │
│   │  D- ────────┼─────────┤        GPIO ├────────→ Pi GPIO    │
│   │             │         │             │                      │
│   │  GND ───────┼─────────┤ GND         │                      │
│   │             │         │             │                      │
│   └─────────────┘         └─────────────┘                      │
│                                                                 │
│   Negotiated Power Profiles:                                   │
│   - 5V @ 3A  (15W) - Default                                   │
│   - 9V @ 2A  (18W) - Fast charge                               │
│   - 12V @ 1.5A (18W) - Alternative                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</pre>

<h3>10.7 Pi GPIO Assignments (Charging)</h3>

<table>
    <tr><th>GPIO</th><th>Function</th><th>Direction</th><th>Notes</th></tr>
    <tr><td>GPIO2</td><td>I2C SDA</td><td>Bidir</td><td>BQ25895 + STUSB4500</td></tr>
    <tr><td>GPIO3</td><td>I2C SCL</td><td>Output</td><td>BQ25895 + STUSB4500</td></tr>
    <tr><td>GPIO17</td><td>CHG_EN</td><td>Output</td><td>BQ25895 CE pin</td></tr>
    <tr><td>GPIO27</td><td>CHG_STAT</td><td>Input</td><td>BQ25895 status</td></tr>
    <tr><td>GPIO22</td><td>CHG_MUX1</td><td>Output</td><td>Pack 1 charge select</td></tr>
    <tr><td>GPIO23</td><td>CHG_MUX2</td><td>Output</td><td>Pack 2 charge select</td></tr>
    <tr><td>GPIO24</td><td>CHG_MUX3</td><td>Output</td><td>Pack 3 charge select</td></tr>
    <tr><td>ADC0</td><td>NTC1</td><td>Analog</td><td>Pack 1 temperature</td></tr>
    <tr><td>ADC1</td><td>NTC2</td><td>Analog</td><td>Pack 2 temperature</td></tr>
    <tr><td>ADC2</td><td>NTC3</td><td>Analog</td><td>Pack 3 temperature</td></tr>
</table>

<p><em>Note: Pi doesn't have native ADC - use MCP3008 or ADS1115 for analog inputs</em></p>

<h3>10.8 Charging BOM</h3>

<table>
    <tr><th>Ref</th><th>Part Number</th><th>Package</th><th>Value</th><th>Qty</th><th>Description</th></tr>
    <tr><td>U3</td><td>BQ25895RTWR</td><td>QFN-24</td><td>-</td><td>1</td><td>USB battery charger IC</td></tr>
    <tr><td>U4</td><td>STUSB4500QTR</td><td>QFN-24</td><td>-</td><td>1</td><td>USB-C PD controller</td></tr>
    <tr><td>Q1-Q3</td><td>Si2301CDS</td><td>SOT-23</td><td>-</td><td>3</td><td>P-FET charge switch</td></tr>
    <tr><td>L2</td><td>SRP4020TA-2R2M</td><td>4x4mm</td><td>2.2µH</td><td>1</td><td>Charger inductor</td></tr>
    <tr><td>J2</td><td>USB4110-GF-A</td><td>-</td><td>-</td><td>1</td><td>USB-C receptacle</td></tr>
    <tr><td>C10</td><td>-</td><td>0805</td><td>10µF 25V</td><td>2</td><td>VBUS capacitor</td></tr>
    <tr><td>R10</td><td>-</td><td>0402</td><td>1kΩ</td><td>1</td><td>ILIM resistor</td></tr>
    <tr><td>R11-R13</td><td>-</td><td>0402</td><td>10kΩ</td><td>3</td><td>Gate pullups</td></tr>
</table>

<hr class="section-divider">

<h2>11. BMS Wiring Detail</h2>

<h3>11.1 Complete 2S BMS Schematic (S8254AA + FS8205A)</h3>

<pre>
                            CELL 2 (+)
                               │
    B+ ────────────────────────┴────────────────────────────── P+
     │                                                     (Pack Output+)
     │
    [R1 100Ω 0402]
     │
     ├─────────────────────────────────────────┐
     │                                         │
     │              S8254AA                    │
     │         ┌──────────────┐               │
     │         │ 1  VDD       │───────────────┘
     │         │              │
     │         │ 2  VM ───────┼─────────────────── BALANCE MID
     │         │              │                    (between cells)
     │         │ 3  VSS ──────┼─────────────────── B-
     │         │              │
     │         │ 4  OC ───────┼──────────┐
     │         │              │          │
     │         │ 5  DO ───────┼───┐      │
     │         │              │   │      │
     │         │ 6  CO ───────┼───┼──┐   │
     │         └──────────────┘   │  │   │
     │                            │  │   │
     │                           [R2]│   │
     │                          1kΩ │[R3]│
     │                            │  │1kΩ│
     │                            │  │   │
     │         FS8205A #1         │  │   │       FS8205A #2
     │        (CHARGE FET)        │  │   │      (DISCHARGE FET)
     │       ┌────────────┐       │  │   │     ┌────────────┐
     │       │            │       │  │   │     │            │
     │       │  1,2,6,7,8 │ DRAIN │  │   │     │  1,2,6,7,8 │ DRAIN
     │       │      │     │───────┼──┼───┼─────│      │     │
     │       │      │     │       │  │   │     │      │     │
     │       │    ──┴──   │       │  │   │     │    ──┴──   │
     │       │   │     │  │       │  │   │     │   │     │  │
     │       │   │FET1 │  │       │  │   │     │   │FET1 │  │
     │       │   │     │  │       │  │   │     │   │     │  │
     │       │    ──┬──   │       │  │   │     │    ──┬──   │
     │       │      │     │       │  │   │     │      │     │
     │       │   3  S1    │───────┘  │   │     │   3  S1    │──────┐
     │       │            │          │   │     │            │      │
     │       │   4  GATE  │──────────┘   │     │   4  GATE  │──────┼──┐
     │       │            │              │     │            │      │  │
     │       │   5  S2    │──────────────┼─────│   5  S2    │──┐   │  │
     │       │            │              │     │            │  │   │  │
     │       └────────────┘              │     └────────────┘  │   │  │
     │                                   │                     │   │  │
     │                                   │                     │   │  │
     │                                   └─────────────────────┼───┘  │
     │                                                         │      │
     │                                                    [R_CS]      │
     │                                                    0.01Ω      │
     │                                                    2512       │
     │                                                         │      │
    B- ────────────────────────────────────────────────────────┴──────┘
     │                                                            │
     │                                                            │
  CELL 1 (-)                                                     P-
                                                           (Pack Output-)
</pre>

<h3>11.2 S8254AA Pin Functions</h3>

<table>
    <tr><th>Pin</th><th>Name</th><th>Function</th><th>Connection</th></tr>
    <tr><td>1</td><td>VDD</td><td>Power supply</td><td>B+ via 100Ω</td></tr>
    <tr><td>2</td><td>VM</td><td>Cell mid-point</td><td>Between Cell 1 and Cell 2</td></tr>
    <tr><td>3</td><td>VSS</td><td>Ground reference</td><td>B- (Cell 1 negative)</td></tr>
    <tr><td>4</td><td>OC</td><td>Overcurrent sense</td><td>Top of sense resistor</td></tr>
    <tr><td>5</td><td>DO</td><td>Discharge control</td><td>FS8205A #2 gate via 1kΩ</td></tr>
    <tr><td>6</td><td>CO</td><td>Charge control</td><td>FS8205A #1 gate via 1kΩ</td></tr>
</table>

<h3>11.3 Protection Thresholds</h3>

<table>
    <tr><th>Protection</th><th>Threshold</th><th>Action</th></tr>
    <tr><td>Overcharge</td><td>4.25V/cell</td><td>CO goes LOW, blocks charge</td></tr>
    <tr><td>Over-discharge</td><td>2.5V/cell</td><td>DO goes LOW, blocks discharge</td></tr>
    <tr><td>Overcurrent</td><td>~8A</td><td>DO goes LOW (based on R_CS)</td></tr>
    <tr><td>Short circuit</td><td>>25A</td><td>Immediate DO shutdown</td></tr>
</table>

<h3>11.4 BMS Component Values</h3>

<table>
    <tr><th>Ref</th><th>Value</th><th>Package</th><th>Purpose</th></tr>
    <tr><td>R1</td><td>100Ω</td><td>0402</td><td>VDD current limit</td></tr>
    <tr><td>R2</td><td>1kΩ</td><td>0402</td><td>CO gate resistor</td></tr>
    <tr><td>R3</td><td>1kΩ</td><td>0402</td><td>DO gate resistor</td></tr>
    <tr><td>R_CS</td><td>0.01Ω (10mΩ)</td><td>2512</td><td>Current sense</td></tr>
    <tr><td>C1</td><td>0.1µF</td><td>0402</td><td>VDD bypass (optional)</td></tr>
</table>

<hr class="section-divider">

<h2>12. Complete System BOM</h2>

<h3>12.1 Battery Pack PCB</h3>

<table>
    <tr><th>Ref</th><th>Part Number</th><th>Package</th><th>Value</th><th>Qty</th><th>Description</th></tr>
    <tr><td>U1</td><td>S8254AA</td><td>TSSOP-8</td><td>-</td><td>1</td><td>2S Protection IC</td></tr>
    <tr><td>U2</td><td>FS8205A</td><td>TSSOP-8</td><td>-</td><td>1</td><td>Dual N-FET (charge)</td></tr>
    <tr><td>U3</td><td>FS8205A</td><td>TSSOP-8</td><td>-</td><td>1</td><td>Dual N-FET (discharge)</td></tr>
    <tr><td>R1</td><td>-</td><td>0402</td><td>100Ω</td><td>1</td><td>VDD resistor</td></tr>
    <tr><td>R2,R3</td><td>-</td><td>0402</td><td>1kΩ</td><td>2</td><td>Gate resistors</td></tr>
    <tr><td>R_CS</td><td>WSL2512R0100F</td><td>2512</td><td>0.01Ω 1W</td><td>1</td><td>Current sense</td></tr>
    <tr><td>NTC1</td><td>NCP18XH103F03RB</td><td>0402</td><td>10kΩ</td><td>1</td><td>Thermistor</td></tr>
    <tr><td>J1</td><td>Mill-Max target</td><td>-</td><td>6-pad</td><td>1</td><td>Pogo pads</td></tr>
</table>

<h3>12.2 Main Board (Power Section)</h3>

<table>
    <tr><th>Ref</th><th>Part Number</th><th>Package</th><th>Value</th><th>Qty</th><th>Description</th></tr>
    <tr><td>U1</td><td>A6211GLJTR-T</td><td>SOT23-8L</td><td>-</td><td>1</td><td>Buck converter</td></tr>
    <tr><td>U2</td><td>INA219BIDCNR</td><td>MSOP-10</td><td>-</td><td>1</td><td>Power monitor</td></tr>
    <tr><td>U3</td><td>BQ25895RTWR</td><td>QFN-24</td><td>-</td><td>1</td><td>USB charger IC</td></tr>
    <tr><td>U4</td><td>STUSB4500QTR</td><td>QFN-24</td><td>-</td><td>1</td><td>USB-C PD controller</td></tr>
    <tr><td>U5</td><td>MCP3008</td><td>SOIC</td><td>-</td><td>1</td><td>ADC for NTC/ID</td></tr>
    <tr><td>L1</td><td>SRP7028A-4R7M</td><td>7x7mm</td><td>4.7µH</td><td>1</td><td>Buck inductor</td></tr>
    <tr><td>L2</td><td>SRP4020TA-2R2M</td><td>4x4mm</td><td>2.2µH</td><td>1</td><td>Charger inductor</td></tr>
    <tr><td>D1-D3</td><td>SS34</td><td>DO-214AB</td><td>40V 3A</td><td>3</td><td>OR-ing diodes</td></tr>
    <tr><td>Q1-Q3</td><td>Si2301CDS</td><td>SOT-23</td><td>-</td><td>3</td><td>P-FET charge mux</td></tr>
    <tr><td>J1-J3</td><td>Mill-Max 0906</td><td>-</td><td>6-pin</td><td>3</td><td>Pogo receptacles</td></tr>
    <tr><td>J4</td><td>USB4110-GF-A</td><td>-</td><td>-</td><td>1</td><td>USB-C connector</td></tr>
    <tr><td>C1-C2</td><td>GRM31CR61E106K</td><td>1206</td><td>10µF 25V</td><td>4</td><td>Input caps</td></tr>
    <tr><td>C3-C5</td><td>GRM21BR61A226M</td><td>0805</td><td>22µF 10V</td><td>3</td><td>Output caps</td></tr>
    <tr><td>C11</td><td>-</td><td>Radial</td><td>1F 10V</td><td>1</td><td>Supercap</td></tr>
</table>

<hr class="section-divider">

<p style="text-align: center; color: #666; margin-top: 40px;">
    <em>Document Version: 1.2 (Charging System Added)</em><br>
    <em>Project: Familiar Firmware Modular Battery System</em>
</p>

</body>
</html>
